@page "/Login"
<PageTitle>Login</PageTitle>

@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations

@using CurrieTechnologies.Razor.SweetAlert2;
@using GestionProyectos.Shared.Models;
@using Microsoft.AspNetCore.Components.Authorization
@using GestionProyectos.Client.Extensions;
@using GestionProyectos.Client.Services.Contrato;

@inject IUsuarioService _usuarioServicio;
@inject NavigationManager _navServicio;
@inject ISnackbar Snackbar;
@inject AuthenticationStateProvider autenticacionProvider;
@inject SweetAlertService Swal;

<EditForm Model="@inicioSesion" OnValidSubmit="OnValidSubmit" OnInvalidSubmit="OnInvalidSubmit" FormName="LoginForm">
<DataAnnotationsValidator/>
    <MudGrid Class="justify-center">
        <MudItem xs="12">
            <MudCard>
                <MudCardContent>
                    <MudTextField T="string" Label="Usuario" @bind-Value="inicioSesion.Usuario" For="@(() => inicioSesion.Usuario)" />
                    <MudTextField T="string" Label="Contraseña" @bind-Value="inicioSesion.Clave" For="@(() => inicioSesion.Clave)"
                                    InputType="InputType.Password"  />
                </MudCardContent>
                <MudCardActions>
                    <MudCheckBox T="bool"  Label="Recordarme" />
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">Iniciar Sesion</MudButton>
                </MudCardActions>
                @* @if (success)
                {
                    <MudText Color="Color.Success">Success</MudText>
                }
                else
                {
                    <MudText Color="@Color.Error">
                        <ValidationSummary />
                    </MudText>
                } *@
            </MudCard>
        </MudItem>
    </MudGrid>
</EditForm>

@code{
    private InicioSesion inicioSesion = new InicioSesion();
    private SesionDTO sesionUsuarioDTO = new SesionDTO();

    bool success = false;

    public class InicioSesion
    {
        [Required(ErrorMessage = "El campo Nombre de Usuario es requerido")]
        public string Usuario { get; set; } = "";

        [Required(ErrorMessage = "El campo Contraseña es requerido")]
        public string Clave { get; set; } = "";
    }

    private async void OnValidSubmit(EditContext context)
    {
        // usuario.NombreUsuario = "Profe";
        // usuario.Clave = "1234";
        // usuario.IdUsuario = 4;
        // usuario.IdRol = 4;

        // sesionUsuario.Rol = "Administrador";
        // sesionUsuario.NombreCompleto = "Profe";
        // sesionUsuario.IdUsuario = 11;
        success = true;
        StateHasChanged();

        try
        {
            var response = await _usuarioServicio.Buscar(inicioSesion.Usuario, inicioSesion.Clave);

            // Si se encuentra al usuario:
            if (response.Rol.ToLower() == "administrador")
            {
                var autenticacionExt = (AutenticacionExtension)autenticacionProvider;
                await autenticacionExt.ActualizarEstadoAutenticacion(response);
                _navServicio.NavigateTo("/Usuarios/Listado");
            }
            else
            {
                Snackbar.Add("Usuario no tiene el rol requerido para el ingreso", Severity.Warning);
            }

            Snackbar.Add("Inicio Exitoso", Severity.Success);
        }
        catch
        {
            // Si no encuentra al usuario:
            Snackbar.Add("Usuario y/o contraseña incorrectos", Severity.Error);
        }

        // try
        // {
        //     var response = await _usuarioServicio.Buscar(inicioSesion.Usuario, inicioSesion.Clave);
        // }
        // catch
        // {
        //     // Si no encuentra al usuario:
        //     Snackbar.Add("No se encuentra al usuario, registrese y vuelva a intentar.", Severity.Error);
        // }

        // // Si se encuentra al usuario:

        // var autenticacionExt = (AutenticacionExtension)autenticacionProvider;
        // await autenticacionExt.ActualizarEstadoAutenticacion(response);

        // if (response.Rol.ToLower() == "administrador")
        // {
        //     //toastService.ShowSuccess("Inicio exitoso.");
        //     _navServicio.NavigateTo("/Usuarios/Listado");
        //     Snackbar.Add("Inicio Exitoso", Severity.Info);
        // }
        // if (!(response.Rol.ToLower() == "administrador"))
        // {
        //     _navServicio.NavigateTo("/");
        //     Snackbar.Add("Inicio Exitoso", Severity.Info);
        //     //toastService.ShowSuccess("Inicio Sesion sin ser Administrador");
        // }

        //await sessionStorage.SetItemAsync("id", usuario.Id);
        //await JsRuntime.InvokeVoidAsync("location.reload");
}
    private void OnInvalidSubmit(EditContext context)
    {
        Console.WriteLine($"Invalido. Usuario: {inicioSesion.Usuario} Clave: {inicioSesion.Clave} Context: {context}");
    }
}


@* @code {
    bool success;
    string[] errors = { };
    MudTextField<string> pwField1;
    MudForm form;

    private IEnumerable<string> PasswordStrength(string pw)
    {
        if (string.IsNullOrWhiteSpace(pw))
        {
            yield return "Password is required!";
            yield break;
        }
        if (pw.Length < 8)
            yield return "Password must be at least of length 8";
        if (!Regex.IsMatch(pw, @"[A-Z]"))
            yield return "Password must contain at least one capital letter";
        if (!Regex.IsMatch(pw, @"[a-z]"))
            yield return "Password must contain at least one lowercase letter";
        if (!Regex.IsMatch(pw, @"[0-9]"))
            yield return "Password must contain at least one digit";
    }

    private string PasswordMatch(string arg)
    {
        if (pwField1.Value != arg)
            return "Passwords don't match";
        return null;
    }

} *@